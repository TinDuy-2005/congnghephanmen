<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Delivery API</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; }
        button:hover { background: #218838; }
        #output { background: #f4f4f4; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
    </style>
</head>
<body>

    <h2>1. Đăng ký (Register)</h2>
    <div class="box">
        <input type="text" id="reg_user" placeholder="Username (VD: manager1)">
        <input type="password" id="reg_pass" placeholder="Password">
        <select id="reg_role">
            <option value="1">Admin</option>
            <option value="2">Manager</option>
            <option value="3">Staff</option>
            <option value="4">Customer</option>
        </select>
        <button onclick="register()">Đăng Ký</button>
    </div>

    <h2>2. Đăng nhập (Login)</h2>
    <div class="box">
        <input type="text" id="login_user" placeholder="Username">
        <input type="password" id="login_pass" placeholder="Password">
        <button onclick="login()" style="background: #007bff;">Đăng Nhập & Lấy Token</button>
    </div>

    <h2>3. Test Quyền (Lấy danh sách đơn)</h2>
    <div class="box">
        <p>Token hiện tại: <span id="token_status" style="color:red; font-weight:bold;">Chưa có</span></p>
        <button onclick="getOrders()" style="background: #ffc107; color: black;">Xem All Đơn Hàng (Manager/Admin)</button>
    </div>

    <h3>Kết quả trả về API:</h3>
    <div id="output">...</div>

    <script>
        let myToken = ''; // Biến lưu token tạm thời

        // Hàm hiện kết quả ra màn hình
        function log(data) {
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        }

        // 1. Đăng ký
        async function register() {
            const username = document.getElementById('reg_user').value;
            const password = document.getElementById('reg_pass').value;
            const role_id = document.getElementById('reg_role').value;

            const res = await fetch('http://localhost:3000/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role_id })
            });
            const data = await res.json();
            log(data);
        }

        // 2. Đăng nhập
        async function login() {
            const username = document.getElementById('login_user').value;
            const password = document.getElementById('login_pass').value;

            const res = await fetch('http://localhost:3000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            
            if (data.token) {
                myToken = data.token;
                document.getElementById('token_status').textContent = "Đã có Token!";
                document.getElementById('token_status').style.color = "green";
            }
            log(data);
        }

        // 3. Gọi API có bảo mật
        async function getOrders() {
            if (!myToken) {
                alert("Bạn chưa đăng nhập!");
                return;
            }

            const res = await fetch('http://localhost:3000/api/orders/all', {
                method: 'GET',
                headers: { 
                    'Authorization': 'Bearer ' + myToken // Gửi kèm Token
                }
            });
            
            if (res.status === 403) {
                log({ error: "Bạn không có quyền xem dữ liệu này!" });
            } else {
                const data = await res.json();
                log(data);
            }
        }
    </script>
</body>
</html>