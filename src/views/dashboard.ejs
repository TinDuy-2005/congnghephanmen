<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Qu·∫£n L√Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; }
        .navbar-brand { font-weight: bold; }
        .hidden { display: none !important; }
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
        }
        .card-header { 
            border-radius: 12px 12px 0 0 !important; 
            font-size: 1.1em;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">üì¶ Delivery Dashboard</a>
        <div class="d-flex align-items-center text-white">
            <span class="me-3">Xin ch√†o, <b id="user-name">User</b> (<span id="user-role">Role</span>)</span>
            <button class="btn btn-danger btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div id="customer-section" class="card mb-4 hidden">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-plus-circle me-2"></i> T·∫°o ƒê∆°n H√†ng M·ªõi
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">M√¥ t·∫£ ƒë∆°n h√†ng:</label>
                        <input type="text" id="order-desc" class="form-control" placeholder="V√≠ d·ª•: Giao t√†i li·ªáu...">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n:</label>
                        <input type="text" id="order-address" class="form-control" placeholder="V√≠ d·ª•: 123 Nguy·ªÖn VƒÉn Linh...">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n:</label>
                        <input type="text" id="order-phone" class="form-control" placeholder="V√≠ d·ª•: 0901234567">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 d-flex justify-content-end">
                        <button class="btn btn-success" onclick="createOrder()">
                            <i class="fas fa-paper-plane me-2"></i> T·∫°o ƒê∆°n
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="admin-section" class="card mb-4 hidden">
            <div class="card-header d-flex justify-content-between align-items-center bg-danger text-white">
                <span class="fw-bold"><i class="fas fa-user-shield me-2"></i> Qu·∫£n L√Ω T√†i Kho·∫£n (Admin)</span>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="showCreateUserModal()">
                        <i class="fas fa-user-plus"></i> T·∫°o User
                    </button>
                    <button class="btn btn-sm btn-light" onclick="loadUsers()">T·∫£i danh s√°ch</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>T√™n ƒë·∫ßy ƒë·ªß</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center bg-white">
                <span class="fw-bold text-dark"><i class="fas fa-list-alt me-2"></i> Danh S√°ch ƒê∆°n H√†ng</span>
                <button class="btn btn-sm btn-secondary" onclick="loadOrders()">üîÑ L√†m m·ªõi</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>M√¥ t·∫£</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Ng√†y t·∫°o</th> 
                                <th>Tr·∫°ng th√°i</th>
                                <th>Shipper</th> 
                                <th>SƒêT Kh√°ch h√†ng</th> 
                                <th id="action-header">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="order-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="editOrderModalLabel">S·ª≠a ƒê∆°n h√†ng #<span id="edit-order-id-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-order-id">
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">M√¥ t·∫£ ƒë∆°n h√†ng</label>
                        <input type="text" class="form-control" id="edit-description">
                    </div>
                    <div class="mb-3">
                        <label for="edit-address" class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n</label>
                        <input type="text" class="form-control" id="edit-address">
                    </div>
                    <div class="mb-3">
                        <label for="edit-phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control" id="edit-phone">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="updateOrder()">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="editUserModalLabel">S·ª≠a User #<span id="edit-user-id-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-user-id">
                    <div class="mb-3">
                        <label for="edit-user-fullname" class="form-label">T√™n ƒë·∫ßy ƒë·ªß</label>
                        <input type="text" class="form-control" id="edit-user-fullname">
                    </div>
                    <div class="mb-3">
                        <label for="edit-user-phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control" id="edit-user-phone">
                    </div>
                    <div class="mb-3">
                        <label for="edit-user-role" class="form-label">Vai tr√≤ m·ªõi</label>
                        <select class="form-select" id="edit-user-role"></select> 
                    </div>
                    <div class="mb-3">
                        <label for="edit-user-password" class="form-label">M·∫≠t kh·∫©u m·ªõi (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                        <input type="password" class="form-control" id="edit-user-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="submitUserUpdate()">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="createUserModalLabel"><i class="fas fa-user-plus me-2"></i> T·∫°o T√†i Kho·∫£n M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="create-username" class="form-label">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                        <input type="text" class="form-control" id="create-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-fullname" class="form-label">T√™n ƒë·∫ßy ƒë·ªß</label>
                        <input type="text" class="form-control" id="create-fullname">
                    </div>
                    <div class="mb-3">
                        <label for="create-phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control" id="create-phone">
                    </div>
                    <div class="mb-3">
                        <label for="create-role" class="form-label">Vai tr√≤</label>
                        <select class="form-select" id="create-role"></select> 
                    </div>
                    <div class="mb-3">
                        <label for="create-password" class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control" id="create-password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-success" onclick="submitCreateUser()">T·∫°o t√†i kho·∫£n</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username') || 'B·∫°n'; 
        const user_id = parseInt(localStorage.getItem('user_id')); 

        if (!token) window.location.href = '/login';
        
        document.getElementById('user-name').innerText = username;
        document.getElementById('user-role').innerText = role;

        // Admin, Manager v√† Customer ƒë·ªÅu th·∫•y ph·∫ßn t·∫°o ƒë∆°n
        if (role === 'Customer' ) { 
            document.getElementById('customer-section').classList.remove('hidden');
        } 
        
        let staffList = []; 
        let rolesList = []; // Danh s√°ch Roles (d√πng cho Modal s·ª≠a User)
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // ---------------------------------------------
        // MANAGER/ADMIN: Load Staffs
        // ---------------------------------------------
        async function loadStaffs() {
            if (role !== 'Admin' && role !== 'Manager') return;
            try {
                const res = await fetch('/api/auth/staffs', { headers: { 'Authorization': 'Bearer ' + token } }); 
                staffList = await res.json();
            } catch (e) { console.error(e); }
        }
        
        // ---------------------------------------------
        // ADMIN: Load Roles
        // ---------------------------------------------
        async function loadRoles() {
            if (role !== 'Admin') return;
            try {
                const res = await fetch('/api/admin/roles', { headers: { 'Authorization': 'Bearer ' + token } });
                rolesList = await res.json();
            } catch (e) { console.error('L·ªói t·∫£i roles:', e); }
        }

        // ---------------------------------------------
        // H√ÄM: T·∫£i ƒê∆°n H√†ng
        // ---------------------------------------------
        async function loadOrders() {
            let apiUrl = '';
            
            if (role === 'Customer') apiUrl = '/api/orders/my-orders';
            else if (role === 'Staff') apiUrl = '/api/orders/assigned-tasks';
            else apiUrl = '/api/orders/all';

            try {
                const res = await fetch(apiUrl, { headers: { 'Authorization': 'Bearer ' + token } });
                const orders = await res.json();
                renderTable(orders);
            } catch (err) {
                console.error("L·ªói t·∫£i ƒë∆°n h√†ng:", err);
            }
        }

        // ---------------------------------------------
        // H√ÄM: V·∫Ω b·∫£ng (Render HTML)
        // ---------------------------------------------
        function renderTable(orders) {
            const tbody = document.getElementById('order-table-body');
            tbody.innerHTML = '';

            if(orders.length === 0) {
                // Colspan 8
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>'; 
                return;
            }

            orders.forEach(order => {
                let actionHtml = '<span class="text-muted">ƒêang x·ª≠ l√Ω</span>'; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh an to√†n
                
                let shipperDisplay = order.staff_name 
                    ? `<span class="fw-bold text-primary">${order.staff_name}</span>` 
                    : (order.staff_id ? `ID: ${order.staff_id}` : '<span class="text-danger">Ch∆∞a c√≥</span>');

                let customerDisplay = order.customer_name 
                    ? `<br><small class="text-muted">Kh√°ch: ${order.customer_name}</small>` 
                    : '';
                
                // --- LOGIC HI·ªÇN TH·ªä N√öT B·∫§M ---
                const safeDescription = (order.description || '').replace(/'/g, "\\'"); 
                const safeAddress = (order.delivery_address || '').replace(/'/g, "\\'"); 
                const safePhone = (order.phone_number || '').replace(/'/g, "\\'"); 
                
                let shipperColumnHtml = `<td>${shipperDisplay}</td>`; // C·ªôt Shipper

                if ((role === 'Manager' || role === 'Admin')) {
                    // ADMIN/MANAGER: S·ª≠a, X√≥a v√† H·ªßy Ph√¢n c√¥ng
                    actionHtml = `
                        <button class="btn btn-sm btn-info me-1" 
                                onclick="showEditModal(${order.id}, '${safeDescription}', '${safeAddress}', '${safePhone}')">
                            S·ª≠a
                        </button>
                        <button class="btn btn-sm btn-danger me-1" 
                                onclick="deleteOrder(${order.id})">
                            X√≥a
                        </button>
                        <hr style="margin: 0.5rem 0;">
                    `;

                    // H√†nh ƒë·ªông Ph√¢n c√¥ng/H·ªßy Ph√¢n c√¥ng
                    if (order.status === 'Pending') {
                        let options = staffList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                        actionHtml += `
                            <div class="input-group input-group-sm">
                                <select id="staff-select-${order.id}" class="form-select" style="max-width: 150px;">
                                    <option value="">Ch·ªçn NV...</option>
                                    ${options}
                                </select>
                                <button class="btn btn-primary" onclick="assignStaff(${order.id})">Giao</button>
                            </div>
                        `;
                    } else if (order.status === 'Assigned' || order.status === 'In Progress') {
                        // N√∫t H·ª¶Y PH√ÇN C√îNG (Ho√†n l·∫°i thao t√°c)
                         actionHtml += `
                            <button class="btn btn-warning btn-sm" 
                                    onclick="unassignShipper(${order.id})">
                                <i class="fas fa-undo"></i> H·ªßy Ph√¢n c√¥ng
                            </button>
                        `;
                    } else {
                         actionHtml += `<span class="text-muted">ƒê√£ ƒë√≥ng</span>`;
                    }
                    
                }

                // CUSTOMER: S·ª≠a/X√≥a ƒë∆°n h√†ng (CH·ªà KHI ƒêANG PENDING) - ‚ú® ƒê√É KH√îI PH·ª§C CH·ª®C NƒÇNG ‚ú®
                else if (role === 'Customer') {
                    if (order.status === 'Pending') {
                        actionHtml = `
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-sm btn-info me-2" 
                                        onclick="showEditModal(${order.id}, '${safeDescription}', '${safeAddress}', '${safePhone}')">
                                    S·ª≠a
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="deleteOrder(${order.id})">
                                    X√≥a
                                </button>
                            </div>
                        `;
                    } else if (order.status === 'Completed' || order.status === 'Cancelled') {
                        actionHtml = '<span class="text-success">Ho√†n t·∫•t</span>';
                    } else {
                        // ƒê∆°n h√†ng Assigned ho·∫∑c In Progress
                        actionHtml = '<span class="text-muted">ƒêang x·ª≠ l√Ω</span>';
                    }
                }
                
                // STAFF: C·∫≠p nh·∫≠t tr·∫°ng th√°i
                else if (role === 'Staff') {
                    if(order.status !== 'Completed' && order.status !== 'Cancelled') {
                        actionHtml = `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-warning" onclick="updateStatus(${order.id}, 'In Progress')">üöÄ ƒêi giao</button>
                                <button class="btn btn-success" onclick="updateStatus(${order.id}, 'Completed')">‚úÖ Xong</button>
                                <button class="btn btn-danger" onclick="updateStatus(${order.id}, 'Cancelled')">‚ùå H·ªßy</button>
                            </div>
                        `;
                    } else {
                        actionHtml = '<span class="text-success">ƒê√£ ƒë√≥ng</span>';
                    }
                }

                let badgeColor = 'bg-secondary';
                if(order.status === 'Assigned') badgeColor = 'bg-info';
                if(order.status === 'In Progress') badgeColor = 'bg-warning text-dark';
                if(order.status === 'Completed') badgeColor = 'bg-success';
                if(order.status === 'Cancelled') badgeColor = 'bg-danger';

                const niceDate = formatDate(order.created_at);

                const row = `
                    <tr>
                        <td>#${order.id}</td>
                        <td>
                            ${order.description}
                            ${customerDisplay}
                        </td>
                        <td>${order.delivery_address}</td>
                        <td><small class="text-muted">${niceDate}</small></td> 
                        <td><span class="badge ${badgeColor}">${order.status}</span></td>
                        <td>${shipperDisplay}</td> <td>${order.phone_number || '-'}</td> <td>${actionHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // ---------------------------------------------
        // C√ÅC H√ÄM X·ª¨ L√ù (CREATE, DELETE, UPDATE, UNASSIGN, ADMIN)
        // ---------------------------------------------
        
        async function createOrder() {
            const desc = document.getElementById('order-desc').value;
            const address = document.getElementById('order-address').value;
            const phone = document.getElementById('order-phone').value;
            const total = 0; 
            
            if (!desc || !address || !phone) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß M√¥ t·∫£, ƒê·ªãa ch·ªâ v√† S·ªë ƒëi·ªán tho·∫°i.');
                return;
            }

            try {
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ description: desc, address: address, phone: phone, total: total })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng! ID: ' + data.orderId);
                    document.getElementById('order-desc').value = '';
                    document.getElementById('order-address').value = '';
                    document.getElementById('order-phone').value = '';
                    loadOrders(); 
                } else {
                    alert('L·ªói t·∫°o ƒë∆°n h√†ng: ' + (data.message || 'Vui l√≤ng ki·ªÉm tra l·∫°i Backend Log.'));
                    console.error(data);
                }
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi API:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ t·∫°o ƒë∆°n h√†ng.');
            }
        }
        
        async function deleteOrder(orderId) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng #${orderId} kh√¥ng?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/delete/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    loadOrders(); 
                } else {
                    alert(`L·ªói khi x√≥a ƒë∆°n: ${result.message || 'Kh√¥ng r√µ l·ªói.'}`);
                }
            } catch (error) {
                console.error('L·ªói network ho·∫∑c server:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ x√≥a ƒë∆°n h√†ng.');
            }
        }
        
        function showEditModal(id, description, address, phone) {
            document.getElementById('edit-order-id').value = id;
            document.getElementById('edit-order-id-display').textContent = id;
            document.getElementById('edit-description').value = description;
            document.getElementById('edit-address').value = address;
            document.getElementById('edit-phone').value = phone;
            
            const editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            editModal.show();
        }

        async function updateOrder() {
            const id = document.getElementById('edit-order-id').value;
            const description = document.getElementById('edit-description').value;
            const address = document.getElementById('edit-address').value;
            const phone = document.getElementById('edit-phone').value;
            const total = 0; // M·∫∑c ƒë·ªãnh l√† 0
            
            if (!description || !address || !phone) {
                 alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß M√¥ t·∫£, ƒê·ªãa ch·ªâ v√† S·ªë ƒëi·ªán tho·∫°i.');
                 return;
            }
            
            const modalElement = document.getElementById('editOrderModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();

            try {
                const response = await fetch(`/api/orders/update/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ description: description, address: address, phone: phone, total: total })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    loadOrders();
                } else {
                    alert(`L·ªói khi s·ª≠a ƒë∆°n: ${result.message || 'Kh√¥ng r√µ l·ªói.'}`);
                }
            } catch (error) {
                console.error('L·ªói network ho·∫∑c server:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ c·∫≠p nh·∫≠t ƒë∆°n h√†ng.');
            }
        }

        async function assignStaff(orderId) {
            const staffSelect = document.getElementById(`staff-select-${orderId}`);
            const staff_id = staffSelect.value;
            
            if (!staff_id) {
                alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n giao h√†ng!");
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/assign/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ staff_id: staff_id })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('Ph√¢n c√¥ng th√†nh c√¥ng!');
                    loadOrders();
                } else {
                    alert('L·ªói ph√¢n c√¥ng: ' + (data.message || 'Kh√¥ng r√µ l·ªói.'));
                }
            } catch (error) {
                console.error('L·ªói ph√¢n c√¥ng API:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ ph√¢n c√¥ng.');
            }
        }

        async function unassignShipper(orderId) {
            if (!confirm(`X√°c nh·∫≠n H·ª¶Y PH√ÇN C√îNG ƒë∆°n h√†ng #${orderId}? ƒê∆°n h√†ng s·∫Ω tr·ªü v·ªÅ tr·∫°ng th√°i "Pending".`)) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/unassign/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({}) // Body tr·ªëng
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    loadOrders();
                } else {
                    alert(`L·ªói h·ªßy ph√¢n c√¥ng: ${result.message || 'Kh√¥ng r√µ l·ªói.'}`);
                }
            } catch (error) {
                console.error('L·ªói API h·ªßy ph√¢n c√¥ng:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ h·ªßy ph√¢n c√¥ng.');
            }
        }

        async function updateStatus(orderId, newStatus) {
            if (!confirm(`X√°c nh·∫≠n chuy·ªÉn tr·∫°ng th√°i ƒë∆°n #${orderId} sang "${newStatus}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/update-status/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadOrders();
                } else {
                    alert(`L·ªói: ${data.message || 'Kh√¥ng r√µ l·ªói.'}`);
                }
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i API:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.');
            }
        }

        // ---------------------------------------------
        // CH·ª®C NƒÇNG: QU·∫¢N L√ù USER (ADMIN ONLY)
        // ---------------------------------------------

        if (role === 'Admin') {
            document.getElementById('admin-section').classList.remove('hidden');
            loadRoles(); 
            loadUsers(); 
        }
        
        async function loadUsers() {
            if (role !== 'Admin') return;
            try {
                const res = await fetch('/api/admin/users', { 
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const users = await res.json();
                renderUsersTable(users);
            } catch (err) {
                console.error("L·ªói t·∫£i User:", err);
            }
        }
        // H√ÄM: M·ªû MODAL T·∫†O USER (ADMIN)
// ---------------------------------------------
function showCreateUserModal() {
    if (role !== 'Admin') return;
    
    // 1. ƒêi·ªÅn danh s√°ch Roles v√†o dropdown
    const select = document.getElementById('create-role');
    select.innerHTML = rolesList.map(r => 
        `<option value="${r.id}">${r.name}</option>`
    ).join('');

    // 2. Clear c√°c tr∆∞·ªùng v√† m·ªü Modal
    document.getElementById('create-username').value = '';
    document.getElementById('create-password').value = '';
    document.getElementById('create-fullname').value = '';
    document.getElementById('create-phone').value = '';

    const createModal = new bootstrap.Modal(document.getElementById('createUserModal'));
    createModal.show();
}

// ---------------------------------------------
// H√ÄM: SUBMIT T·∫†O USER (ADMIN) - G·ª≠i API
// ---------------------------------------------
async function submitCreateUser() {
    const username = document.getElementById('create-username').value;
    const password = document.getElementById('create-password').value;
    const fullName = document.getElementById('create-fullname').value;
    const phone = document.getElementById('create-phone').value;
    const roleId = document.getElementById('create-role').value; // L·∫•y roleId t·ª´ dropdown

    if (!username || !password || !roleId) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·ªß T√™n ƒëƒÉng nh·∫≠p, M·∫≠t kh·∫©u v√† Vai tr√≤.');
        return;
    }
    
    // ƒê√≥ng Modal tr∆∞·ªõc khi g·ªçi API
    const modalElement = document.getElementById('createUserModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) modal.hide();

    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/admin/users', { // ‚¨ÖÔ∏è G·ªçi API POST /api/admin/users
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ 
                username: username, 
                password: password,
                full_name: fullName, 
                phone_number: phone, 
                role_id: roleId // ‚¨ÖÔ∏è G·ª≠i role_id (ID s·ªë)
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('T·∫°o t√†i kho·∫£n User th√†nh c√¥ng!');
            loadUsers(); // T·∫£i l·∫°i danh s√°ch User
        } else {
            alert(`L·ªói t·∫°o t√†i kho·∫£n: ${data.message || 'Kh√¥ng r√µ l·ªói.'}`);
        }
    } catch (error) {
        console.error('L·ªói k·∫øt n·ªëi API:', error);
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.');
    }
}
        function renderUsersTable(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            
            if(users.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" class="text-center">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o</td></tr>';
                 return;
            }

            users.forEach(user => {
                const statusText = user.is_active ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a';
                const statusColor = user.is_active ? 'text-success' : 'text-danger';
                
                const currentUserId = parseInt(localStorage.getItem('user_id'));
                const canLock = user.id !== currentUserId; 

                const lockButton = user.is_active 
                    ? `<button class="btn btn-sm btn-warning me-1" onclick="lockUser(${user.id}, false)" ${!canLock ? 'disabled' : ''}><i class="fas fa-lock"></i> Kh√≥a</button>`
                    : `<button class="btn btn-sm btn-success me-1" onclick="lockUser(${user.id}, true)" ${!canLock ? 'disabled' : ''}><i class="fas fa-unlock"></i> M·ªü kh√≥a</button>`;

                const userFullName = (user.full_name || '').replace(/'/g, "\\'"); 
                const userPhone = (user.phone_number || '').replace(/'/g, "\\'"); 
                const userRolesList = (user.roles_list || '').replace(/'/g, "\\'"); 

                const actionHtml = `
                    <button class="btn btn-sm btn-info me-1" 
                            onclick="showEditUserModal(${user.id}, '${user.username}', '${userFullName}', '${userPhone}', '${userRolesList}')">
                        <i class="fas fa-edit"></i> S·ª≠a
                    </button>
                    ${lockButton}
                `;

                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${userFullName || '-'}</td>
                        <td>${userRolesList || 'Kh√¥ng c√≥'}</td>
                        <td><span class="${statusColor}">${statusText}</span></td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        async function lockUser(id, isActive) {
            const actionText = isActive ? 'm·ªü kh√≥a' : 'kh√≥a';
            if (!confirm(`X√°c nh·∫≠n ${actionText} t√†i kho·∫£n #${id}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${id}/lock`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ isActive: isActive })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    loadUsers(); 
                } else {
                    alert(`L·ªói: ${data.message || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán t√°c v·ª•.'}`);
                }
            } catch (error) {
                console.error('L·ªói API kh√≥a/m·ªü kh√≥a:', error);
            }
        }
        
        function showEditUserModal(id, username, fullName, phone, rolesListString) {
            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-id-display').textContent = id;
            document.getElementById('edit-user-fullname').value = fullName;
            document.getElementById('edit-user-phone').value = phone;
            document.getElementById('edit-user-password').value = ''; 
            
            const select = document.getElementById('edit-user-role');
            select.innerHTML = rolesList.map(r => 
                `<option value="${r.id}" ${rolesListString.includes(r.name) ? 'selected' : ''}>${r.name}</option>`
            ).join('');

            const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            editModal.show();
        }

        async function submitUserUpdate() {
            const id = document.getElementById('edit-user-id').value;
            const fullName = document.getElementById('edit-user-fullname').value;
            const phone = document.getElementById('edit-user-phone').value;
            const newRoleId = document.getElementById('edit-user-role').value;
            const newPassword = document.getElementById('edit-user-password').value;

            if (!newRoleId) {
                 alert('Vui l√≤ng ch·ªçn m·ªôt vai tr√≤.');
                 return;
            }

            const modalElement = document.getElementById('editUserModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();

            try {
                const response = await fetch(`/api/admin/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        full_name: fullName, 
                        phone_number: phone, 
                        new_role_id: newRoleId,
                        new_password: newPassword || null 
                    })
                });
                
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    loadUsers();
                } else {
                    alert(`L·ªói c·∫≠p nh·∫≠t User: ${data.message || 'Kh√¥ng r√µ l·ªói.'}`);
                }

            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi API:', error);
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            window.location.href = '/login';
        }

        // Kh·ªüi t·∫°o trang: T·∫£i danh s√°ch staff v√† ƒë∆°n h√†ng
        loadStaffs();
        loadOrders();
        loadRoles(); 
        loadUsers();
        
        // G√°n c√°c h√†m v√†o window scope ƒë·ªÉ HTML c√≥ th·ªÉ g·ªçi
        window.logout = logout;
        window.loadOrders = loadOrders;
        window.loadStaffs = loadStaffs; // B·ªï sung ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ th·ªÉ g·ªçi l·∫°i
        window.createOrder = createOrder;
        window.deleteOrder = deleteOrder;
        window.showEditModal = showEditModal;
        window.updateOrder = updateOrder;
        window.assignStaff = assignStaff;
        window.updateStatus = updateStatus;
        window.unassignShipper = unassignShipper; 
        window.loadUsers = loadUsers;
        window.lockUser = lockUser;
        window.showEditUserModal = showEditUserModal;
        window.submitCreateUser = submitCreateUser;
        window.submitUserUpdate = submitUserUpdate;
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>