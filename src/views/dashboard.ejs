<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Qu·∫£n L√Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">üì¶ Delivery System</a>
        <div class="d-flex align-items-center text-white">
            <span class="me-3">Xin ch√†o, <b id="user-name">User</b> (<span id="user-role">Role</span>)</span>
            <button class="btn btn-danger btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div id="customer-section" class="card mb-4 hidden">
            <div class="card-header bg-primary text-white">üìù T·∫°o ƒê∆°n H√†ng M·ªõi</div>
            <div class="card-body">
                <div class="mb-3">
                    <label>M√¥ t·∫£ ƒë∆°n h√†ng:</label>
                    <input type="text" id="order-desc" class="form-control" placeholder="V√≠ d·ª•: Giao t√†i li·ªáu...">
                </div>
                <div class="mb-3">
                    <label>ƒê·ªãa ch·ªâ nh·∫≠n:</label>
                    <input type="text" id="order-address" class="form-control" placeholder="V√≠ d·ª•: 123 Nguy·ªÖn VƒÉn Linh...">
                </div>
                <button class="btn btn-success" onclick="createOrder()">T·∫°o ƒê∆°n</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">üìã Danh S√°ch ƒê∆°n H√†ng</span>
                <button class="btn btn-sm btn-secondary" onclick="loadOrders()">üîÑ L√†m m·ªõi</button>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>M√¥ t·∫£</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Ng√†y t·∫°o</th> 
                            <th>Tr·∫°ng th√°i</th>
                            <th>Shipper</th>
                            <th id="action-header">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username') || 'B·∫°n'; // B·∫°n c·∫ßn l∆∞u th√™m username l√∫c login n·∫øu mu·ªën hi·ªán t√™n

        // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!token) window.location.href = '/login';
        
        document.getElementById('user-name').innerText = username;
        document.getElementById('user-role').innerText = role;

        // 2. ·∫®n/Hi·ªán giao di·ªán theo Role
        if (role === 'Customer') {
            document.getElementById('customer-section').classList.remove('hidden');
        } 
        
        // 3. Bi·∫øn l∆∞u danh s√°ch staff (cho Manager d√πng)
        let staffList = [];

        // ---------------------------------------------
        // H√ÄM: T·∫£i danh s√°ch Staff (Ch·ªâ Manager m·ªõi g·ªçi)
        // ---------------------------------------------
        async function loadStaffs() {
            if (role !== 'Admin' && role !== 'Manager') return;
            try {
                const res = await fetch('/api/auth/staffs'); // G·ªçi API v·ª´a th√™m
                staffList = await res.json();
            } catch (e) { console.error(e); }
        }

        // ---------------------------------------------
        // H√ÄM: T·∫£i ƒê∆°n H√†ng
        // ---------------------------------------------
        async function loadOrders() {
            let apiUrl = '';
            
            // Ch·ªçn API ph√π h·ª£p v·ªõi Role
            if (role === 'Customer') apiUrl = '/api/orders/my-orders';
            else if (role === 'Staff') apiUrl = '/api/orders/assigned-tasks';
            else apiUrl = '/api/orders/all'; // Manager/Admin

            try {
                const res = await fetch(apiUrl, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const orders = await res.json();
                renderTable(orders);
            } catch (err) {
                console.error("L·ªói t·∫£i ƒë∆°n h√†ng:", err);
            }
        }
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    // Format theo ki·ªÉu Vi·ªát Nam: Gi·ªù:Ph√∫t Ng√†y/Th√°ng/NƒÉm
    return date.toLocaleString('vi-VN', { 
        hour: '2-digit', 
        minute: '2-digit', 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });
}
        // ---------------------------------------------
        // H√ÄM: V·∫Ω b·∫£ng (Render HTML)
        // ---------------------------------------------

function renderTable(orders) {
    const tbody = document.getElementById('order-table-body');
    tbody.innerHTML = '';

    if(orders.length === 0) {
        // ‚ú® ƒê√É S·ª¨A: C·∫≠p nh·∫≠t colspan l√™n 7 v√¨ ƒë√£ th√™m 1 c·ªôt 'Ng√†y t·∫°o'
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
        return;
    }

    orders.forEach(order => {
        let actionHtml = '<span class="text-muted">...</span>';
        
        // Hi·ªÉn th·ªã t√™n Shipper (n·∫øu c√≥)
        let shipperDisplay = order.staff_name 
            ? `<span class="fw-bold text-primary">${order.staff_name}</span>` 
            : (order.staff_id ? `ID: ${order.staff_id}` : '<span class="text-danger">Ch∆∞a c√≥</span>');

        // Hi·ªÉn th·ªã t√™n Kh√°ch h√†ng (D√†nh cho Manager/Staff xem)
        let customerDisplay = order.customer_name 
            ? `<br><small class="text-muted">Kh√°ch: ${order.customer_name}</small>` 
            : '';

        // --- LOGIC HI·ªÇN TH·ªä N√öT B·∫§M (GI·ªÆ NGUY√äN) ---
        if ((role === 'Manager' || role === 'Admin') && order.status === 'Pending') {
            let options = staffList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            actionHtml = `
                <div class="input-group input-group-sm">
                    <select id="staff-select-${order.id}" class="form-select" style="max-width: 150px;">
                        <option value="">Ch·ªçn NV...</option>
                        ${options}
                    </select>
                    <button class="btn btn-primary" onclick="assignStaff(${order.id})">Giao</button>
                </div>
            `;
        }

        if (role === 'Staff') {
            // Staff ch·ªâ ƒë∆∞·ª£c b·∫•m n√∫t n·∫øu ƒë∆°n ch∆∞a ho√†n th√†nh ho·∫∑c h·ªßy
            if(order.status !== 'Completed' && order.status !== 'Cancelled') {
                actionHtml = `
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="updateStatus(${order.id}, 'In Progress')">üöÄ ƒêi giao</button>
                        <button class="btn btn-success" onclick="updateStatus(${order.id}, 'Completed')">‚úÖ Xong</button>
                        <button class="btn btn-danger" onclick="updateStatus(${order.id}, 'Cancelled')">‚ùå H·ªßy</button>
                    </div>
                `;
            } else {
                actionHtml = '<span class="text-success">ƒê√£ ƒë√≥ng</span>';
            }
        }

        // T·∫°o m√†u cho tr·∫°ng th√°i
        let badgeColor = 'bg-secondary';
        if(order.status === 'Assigned') badgeColor = 'bg-info';
        if(order.status === 'In Progress') badgeColor = 'bg-warning text-dark';
        if(order.status === 'Completed') badgeColor = 'bg-success';
        if(order.status === 'Cancelled') badgeColor = 'bg-danger';

    
        // S·ª¨ D·ª§NG H√ÄM formatDate ·ªû ƒê√ÇY
        const niceDate = formatDate(order.created_at);

        const row = `
            <tr>
                <td>#${order.id}</td>
                <td>
                    ${order.description}
                    ${customerDisplay}
                </td>
                <td>${order.address}</td>
                <td><small class="text-muted">${niceDate}</small></td> 
                <td><span class="badge ${badgeColor}">${order.status}</span></td>
                <td>${shipperDisplay}</td>
                <td>${actionHtml}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}
function logout() {
        // 1. X√≥a to√†n b·ªô th√¥ng tin trong LocalStorage
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        localStorage.removeItem('username');
        
        // 2. Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
        window.location.href = '/login';
    }
    // G√°n c√°c h√†m c·∫ßn thi·∫øt cho scope to√†n c·ª•c ƒë·ªÉ HTML c√≥ th·ªÉ g·ªçi
    window.logout = logout;
    window.loadOrders = loadOrders;
    // window.createOrder = createOrder; // C·∫ßn h√†m n√†y n·∫øu b·∫°n mu·ªën d√πng n√∫t "T·∫°o ƒê∆°n"
    // window.assignStaff = assignStaff; // C·∫ßn h√†m n√†y n·∫øu b·∫°n mu·ªën d√πng n√∫t "Giao"
    // window.updateStatus = updateStatus; // C·∫ßn h√†m n√†y n·∫øu b·∫°n mu·ªën d√πng n√∫t "ƒêi giao/Xong/H·ªßy"

    // Kh·ªüi t·∫°o trang: T·∫£i danh s√°ch staff v√† ƒë∆°n h√†ng
    loadStaffs();
    loadOrders();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>